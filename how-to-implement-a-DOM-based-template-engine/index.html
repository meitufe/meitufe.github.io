<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        
            å¦‚ä½•å®ç°ä¸€ä¸ªåŸºäº DOM çš„æ¨¡æ¿å¼•æ“ - Meitu FE
        
    </title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/dist/css/github-gist.css">
    <link rel="stylesheet" href="/dist/css/app.css">
</head>


<body data-page="article">


<header class="header">
    <nav class="nav">
        <div class="container">
            <div class="logo">
                <a href="http://fe.meitu.com">
                    <img src="/images/logo.png" alt="Meitu FE">
                </a>
            </div>
            <ul class="menu">
                
                <li><a href="/">HOME</a></li>
                
                <li><a href="https://github.com/meitufe">GITHUB</a></li>
                
            </ul>
        </div>
    </nav>
</header>


<div class="page-content">
    <div class="container">
        <article class="article">
            <header class="article-header">
                <h1 class="article-title">å¦‚ä½•å®ç°ä¸€ä¸ªåŸºäº DOM çš„æ¨¡æ¿å¼•æ“</h1>
                <div class="article-meta">
                    <span>ğŸŒ°</span>
                    <span>publish at</span>
                    <time class="article-date" datetime="2017-08-06">2017-08-06</time>
                </div>
            </header>
            <section class="article-content">
                 <p>å¯èƒ½ä½ å·²ç»ä½“ä¼šåˆ°äº† <code>Vue</code> æ‰€å¸¦æ¥çš„ä¾¿æ·äº†ï¼Œç›¸ä¿¡æœ‰ä¸€éƒ¨åˆ†åŸå› ä¹Ÿæ˜¯å› ä¸ºå…¶åŸºäº DOM çš„è¯­æ³•ç®€æ´çš„æ¨¡æ¿æ¸²æŸ“å¼•æ“ã€‚è¿™ç¯‡æ–‡ç« å°†ä¼šä»‹ç»å¦‚ä½•å®ç°ä¸€ä¸ªåŸºäº DOM çš„æ¨¡æ¿å¼•æ“ï¼ˆå°±åƒ <code>Vue</code> çš„æ¨¡æ¿å¼•æ“ä¸€æ ·ï¼‰ã€‚</p>
<h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æœ€ç»ˆçš„æ•ˆæœï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compiled = Compile(<span class="string">`&lt;h1&gt;Hey ğŸŒ°, &#123;&#123; greeting &#125;&#125;&lt;/h1&gt;`</span>, &#123;</span><br><span class="line">    greeting: <span class="string">`Hello World`</span>,</span><br><span class="line">&#125;);</span><br><span class="line">compiled.view <span class="comment">// =&gt; `&lt;h1&gt;Hey ğŸŒ°, Hello World&lt;/h1&gt;`</span></span><br></pre></td></tr></table></figure>
<h2 id="Compile"><a href="#Compile" class="headerlink" title="Compile"></a>Compile</h2><p>å®ç°ä¸€ä¸ªæ¨¡æ¿å¼•æ“å®é™…ä¸Šå°±æ˜¯å®ç°ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå°±åƒè¿™æ ·ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compiled = Compile(template: <span class="built_in">String</span>|Node, <span class="attr">data</span>: <span class="built_in">Object</span>);</span><br><span class="line">compiled.view <span class="comment">// =&gt; compiled template</span></span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>Compile</code> å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compile.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * template compiler</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;String|Node&#125; template</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Compile</span>(<span class="params">template, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Compile)) <span class="keyword">return</span> <span class="keyword">new</span> Compile(template, data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.options = &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.data = data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (template <span class="keyword">instanceof</span> Node) &#123;</span><br><span class="line">        <span class="keyword">this</span>.options.template = template;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> template === <span class="string">'string'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.options.template = domify(template);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">`"template" only accept DOM node or string template`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    template = <span class="keyword">this</span>.options.template;</span><br><span class="line"></span><br><span class="line">    walk(template, (node, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.nodeType === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// compile element node</span></span><br><span class="line">            <span class="keyword">this</span>.compile.elementNodes.call(<span class="keyword">this</span>, node);</span><br><span class="line">            <span class="keyword">return</span> next();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.nodeType === <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="comment">// compile text node</span></span><br><span class="line">            <span class="keyword">this</span>.compile.textNodes.call(<span class="keyword">this</span>, node);</span><br><span class="line">        &#125;</span><br><span class="line">        next();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.view = template;</span><br><span class="line">    template = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Compile.compile = &#123;&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="walk"><a href="#walk" class="headerlink" title="walk"></a>walk</h3><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ° <code>Compile</code> çš„æ„é€ å‡½æ•°ä¸»è¦å°±æ˜¯åšäº†ä¸€ä»¶äº‹ â€”â€”â€”â€” éå† <code>template</code>ï¼Œç„¶åé€šè¿‡åˆ¤æ–­èŠ‚ç‚¹ç±»å‹çš„ä¸åŒæ¥åšä¸åŒçš„ç¼–è¯‘æ“ä½œï¼Œè¿™é‡Œå°±ä¸ä»‹ç»å¦‚ä½•éå† <code>template</code> äº†ï¼Œä¸æ˜ç™½çš„è¯å¯ä»¥ç›´æ¥çœ‹ <code>walk</code> <a href="https://github.com/colonjs/colon/blob/master/src/compile/walk.js" target="_blank" rel="noopener">å‡½æ•°çš„æºç </a>ï¼Œæˆ‘ä»¬ç€é‡æ¥çœ‹ä¸‹å¦‚ä½•ç¼–è¯‘è¿™äº›ä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Œä»¥ç¼–è¯‘ <code>node.nodeType === 1</code> çš„å…ƒç´ èŠ‚ç‚¹ä¸ºä¾‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * compile element node</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;Node&#125; node</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Compile.compile.elementNodes = <span class="function"><span class="keyword">function</span> (<span class="params">node</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> bindSymbol = <span class="string">`:`</span>;</span><br><span class="line">    <span class="keyword">let</span> attributes = [].slice.call(node.attributes),</span><br><span class="line">        attrName = <span class="string">``</span>,</span><br><span class="line">        attrValue = <span class="string">``</span>,</span><br><span class="line">        directiveName = <span class="string">``</span>;</span><br><span class="line"></span><br><span class="line">    attributes.map(<span class="function"><span class="params">attribute</span> =&gt;</span> &#123;</span><br><span class="line">        attrName = attribute.name;</span><br><span class="line">        attrValue = attribute.value.trim();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (attrName.indexOf(bindSymbol) === <span class="number">0</span> &amp;&amp; attrValue !== <span class="string">''</span>) &#123;</span><br><span class="line">            directiveName = attrName.slice(bindSymbol.length);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.bindDirective(&#123;</span><br><span class="line">                node,</span><br><span class="line">                expression: attrValue,</span><br><span class="line">                name: directiveName,</span><br><span class="line">            &#125;);</span><br><span class="line">            node.removeAttribute(attrName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.bindAttribute(node, attribute);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å™¢å¿˜è®°è¯´äº†ï¼Œè¿™é‡Œæˆ‘å‚è€ƒäº† <code>Vue</code> çš„æŒ‡ä»¤è¯­æ³•ï¼Œå°±æ˜¯åœ¨å¸¦æœ‰å†’å· <code>:</code> çš„å±æ€§åä¸­ï¼ˆå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•å…¶ä»–ä½ æ‰€å–œæ¬¢çš„ç¬¦å·ï¼‰ï¼Œå¯ä»¥ç›´æ¥å†™ JavaScript çš„è¡¨è¾¾å¼ï¼Œç„¶åä¹Ÿä¼šæä¾›å‡ ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ <code>:text</code>, <code>:show</code> ç­‰ç­‰æ¥å¯¹å…ƒç´ åšä¸€äº›ä¸åŒçš„æ“ä½œã€‚</p>
<p>å…¶å®è¯¥å‡½æ•°åªåšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>éå†è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§ï¼Œé€šè¿‡åˆ¤æ–­å±æ€§ç±»å‹çš„ä¸åŒæ¥åšä¸åŒçš„æ“ä½œï¼Œåˆ¤æ–­çš„æ ‡å‡†å°±æ˜¯å±æ€§åæ˜¯å¦æ˜¯å†’å· <code>:</code> å¼€å¤´å¹¶ä¸”å±æ€§çš„å€¼ä¸ä¸ºç©ºï¼›</li>
<li>ç»‘å®šç›¸åº”çš„æŒ‡ä»¤å»æ›´æ–°å±æ€§ã€‚</li>
</ul>
<h2 id="Directive"><a href="#Directive" class="headerlink" title="Directive"></a>Directive</h2><p>å…¶æ¬¡ï¼Œå†çœ‹ä¸€ä¸‹ <code>Directive</code> å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> directives <span class="keyword">from</span> <span class="string">'./directives'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; generate &#125; <span class="keyword">from</span> <span class="string">'./compile/generate'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Directive</span>(<span class="params">options = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.assign(<span class="keyword">this</span>, options);</span><br><span class="line">    <span class="built_in">Object</span>.assign(<span class="keyword">this</span>, directives[<span class="keyword">this</span>.name]);</span><br><span class="line">    <span class="keyword">this</span>.beforeUpdate &amp;&amp; <span class="keyword">this</span>.beforeUpdate();</span><br><span class="line">    <span class="keyword">this</span>.update &amp;&amp; <span class="keyword">this</span>.update(generate(<span class="keyword">this</span>.expression)(<span class="keyword">this</span>.compile.options.data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Directive</code> åšäº†ä¸‰ä»¶äº‹ï¼š</p>
<ul>
<li>æ³¨å†ŒæŒ‡ä»¤ï¼ˆ<code>Object.assign(this, directives[this.name])</code>ï¼‰ï¼›</li>
<li>è®¡ç®—æŒ‡ä»¤è¡¨è¾¾å¼çš„å®é™…å€¼ï¼ˆ<code>generate(this.expression)(this.compile.options.data)</code>ï¼‰ï¼›</li>
<li>æŠŠè®¡ç®—å‡ºæ¥çš„å®é™…å€¼æ›´æ–°åˆ° DOM ä¸Šé¢(<code>this.update()</code>)ã€‚</li>
</ul>
<p>åœ¨ä»‹ç»æŒ‡ä»¤ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹å®ƒçš„ç”¨æ³•ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Compile.prototype.bindDirective = <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> Directive(&#123;</span><br><span class="line">        ...options,</span><br><span class="line">        compile: <span class="keyword">this</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Compile.prototype.bindAttribute = <span class="function"><span class="keyword">function</span> (<span class="params">node, attribute</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasInterpolation(attribute.value) || attribute.value.trim() == <span class="string">''</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.bindDirective(&#123;</span><br><span class="line">        node,</span><br><span class="line">        name: <span class="string">'attribute'</span>,</span><br><span class="line">        expression: parse.text(attribute.value),</span><br><span class="line">        attrName: attribute.name,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>bindDirective</code> å¯¹ <code>Directive</code> åšäº†ä¸€ä¸ªéå¸¸ç®€å•çš„å°è£…ï¼Œæ¥å—ä¸‰ä¸ªå¿…å¡«å±æ€§ï¼š</p>
<ul>
<li><code>node</code>: å½“å‰æ‰€ç¼–è¯‘çš„èŠ‚ç‚¹ï¼Œåœ¨ <code>Directive</code> çš„ <code>update</code> æ–¹æ³•ä¸­ç”¨æ¥æ›´æ–°å½“å‰èŠ‚ç‚¹ï¼›</li>
<li><code>name</code>: å½“å‰æ‰€ç»‘å®šçš„æŒ‡ä»¤åç§°ï¼Œç”¨æ¥åŒºåˆ†å…·ä½“ä½¿ç”¨å“ªä¸ªæŒ‡ä»¤æ›´æ–°å™¨æ¥æ›´æ–°è§†å›¾ï¼›</li>
<li><code>expression</code>: parse ä¹‹åçš„ JavaScript çš„è¡¨è¾¾å¼ã€‚</li>
</ul>
<h3 id="updater"><a href="#updater" class="headerlink" title="updater"></a>updater</h3><p>åœ¨ <code>Directive</code> å†…éƒ¨æˆ‘ä»¬é€šè¿‡ <code>Object.assign(this, directives[this.name]);</code> æ¥æ³¨å†Œä¸åŒçš„æŒ‡ä»¤ï¼Œæ‰€ä»¥å˜é‡ <code>directives</code> çš„å€¼å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// directives</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="comment">// directive `:show`</span></span><br><span class="line">    show: &#123;</span><br><span class="line">        beforeUpdate() &#123;&#125;,</span><br><span class="line">        update(show) &#123;</span><br><span class="line">            <span class="keyword">this</span>.node.style.display = show ? <span class="string">`block`</span> : <span class="string">`none`</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// directive `:text`</span></span><br><span class="line">    text: &#123;</span><br><span class="line">        beforeUpdate() &#123;&#125;,</span><br><span class="line">        update(value) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å‡è®¾æŸä¸ªæŒ‡ä»¤çš„åå­—æ˜¯ <code>show</code> çš„è¯ï¼Œé‚£ä¹ˆ <code>Object.assign(this, directives[this.name]);</code> å°±ç­‰åŒäºï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.assign(<span class="keyword">this</span>, &#123;</span><br><span class="line">    beforeUpdate() &#123;&#125;,</span><br><span class="line">    update(show) &#123;</span><br><span class="line">        <span class="keyword">this</span>.node.style.display = show ? <span class="string">`block`</span> : <span class="string">`none`</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>è¡¨ç¤ºå¯¹äºæŒ‡ä»¤ <code>show</code>ï¼ŒæŒ‡ä»¤æ›´æ–°å™¨ä¼šæ”¹å˜è¯¥å…ƒç´  <code>style</code> çš„ <code>display</code> å€¼ï¼Œä»è€Œå®ç°å¯¹åº”çš„åŠŸèƒ½ã€‚æ‰€ä»¥ä½ ä¼šå‘ç°ï¼Œæ•´ä¸ªç¼–è¯‘å™¨ç»“æ„è®¾è®¡å¥½åï¼Œå¦‚æœæˆ‘ä»¬è¦æ‹“å±•åŠŸèƒ½çš„è¯ï¼Œåªéœ€ç®€å•åœ°ç¼–å†™æŒ‡ä»¤çš„æ›´æ–°å™¨å³å¯ï¼Œè¿™é‡Œå†ä»¥æŒ‡ä»¤ <code>text</code> ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// directives</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="comment">// directive `:show`</span></span><br><span class="line">    <span class="comment">// show: &#123; ... &#125;,</span></span><br><span class="line">    <span class="comment">// directive `:text`</span></span><br><span class="line">    text: &#123;</span><br><span class="line">        update(value) &#123;</span><br><span class="line">            <span class="keyword">this</span>.node.textContent = value;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æœ‰æ²¡æœ‰å‘ç°ç¼–å†™ä¸€ä¸ªæŒ‡ä»¤å…¶å®éå¸¸çš„ç®€å•ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥è¿™ä¹ˆä½¿ç”¨æˆ‘ä»¬çš„ <code>text</code> æŒ‡ä»¤äº†ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compiled = Compile(<span class="string">`&lt;h1 :text="'Hey ğŸŒ°, ' + greeting"&gt;&lt;/h1&gt;`</span>, &#123;</span><br><span class="line">    greeting: <span class="string">`Hello World`</span>,</span><br><span class="line">&#125;);</span><br><span class="line">compiled.view <span class="comment">// =&gt; `&lt;h1&gt;Hey ğŸŒ°, Hello World&lt;/h1&gt;`</span></span><br></pre></td></tr></table></figure>
<h3 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h3><p>è®²åˆ°è¿™é‡Œï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹æ²¡æœ‰æåˆ°ï¼Œå°±æ˜¯æˆ‘ä»¬å¦‚ä½•æŠŠ <code>data</code> çœŸå®æ•°æ®æ¸²æŸ“åˆ°æ¨¡æ¿ä¸­ï¼Œæ¯”å¦‚ <code>&lt;h1&gt;Hey ğŸŒ°, &lt;/h1&gt;</code> å¦‚ä½•æ¸²æŸ“æˆ <code>&lt;h1&gt;Hey ğŸŒ°, Hello World&lt;/h1&gt;</code>ï¼Œé€šè¿‡ä¸‹é¢ä¸‰ä¸ªæ­¥éª¤å³å¯è®¡ç®—å‡ºè¡¨è¾¾å¼çš„çœŸå®æ•°æ®ï¼š</p>
<ul>
<li>æŠŠ <code>&lt;h1&gt;Hey ğŸŒ°, &lt;/h1&gt;</code> è§£ææˆ <code>&#39;Hey ğŸŒ°, &#39; + greeting</code> è¿™æ ·çš„ JavaScript è¡¨è¾¾å¼ï¼›</li>
<li>æå–å…¶ä¸­çš„ä¾èµ–å˜é‡å¹¶å–å¾—æ‰€åœ¨ <code>data</code> ä¸­çš„å¯¹åº”å€¼ï¼›</li>
<li>åˆ©ç”¨ <code>new Function()</code> æ¥åˆ›å»ºä¸€ä¸ªåŒ¿åå‡½æ•°æ¥è¿”å›è¿™ä¸ªè¡¨è¾¾å¼ï¼›</li>
<li>æœ€åé€šè¿‡è°ƒç”¨è¿™ä¸ªåŒ¿åå‡½æ•°æ¥è¿”å›æœ€ç»ˆè®¡ç®—å‡ºæ¥çš„æ•°æ®å¹¶é€šè¿‡æŒ‡ä»¤çš„ <code>update</code> æ–¹æ³•æ›´æ–°åˆ°è§†å›¾ä¸­ã€‚</li>
</ul>
<h4 id="parse-text"><a href="#parse-text" class="headerlink" title="parse text"></a>parse text</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reference: https://github.com/vuejs/vue/blob/dev/src/compiler/parser/text-parser.js#L15-L41</span></span><br><span class="line"><span class="keyword">const</span> tagRE = <span class="regexp">/\&#123;\&#123;((?:.|\n)+?)\&#125;\&#125;/g</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tagRE.test(text)) <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(text);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> tokens = [];</span><br><span class="line">    <span class="keyword">let</span> lastIndex = tagRE.lastIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> index, matched;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (matched = tagRE.exec(text)) &#123;</span><br><span class="line">        index = matched.index;</span><br><span class="line">        <span class="keyword">if</span> (index &gt; lastIndex) &#123;</span><br><span class="line">            tokens.push(<span class="built_in">JSON</span>.stringify(text.slice(lastIndex, index)));</span><br><span class="line">        &#125;</span><br><span class="line">        tokens.push(matched[<span class="number">1</span>].trim());</span><br><span class="line">        lastIndex = index + matched[<span class="number">0</span>].length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastIndex &lt; text.length) tokens.push(<span class="built_in">JSON</span>.stringify(text.slice(lastIndex)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tokens.join(<span class="string">'+'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°æˆ‘æ˜¯ç›´æ¥å‚è€ƒ <code>Vue</code> çš„å®ç°ï¼Œå®ƒä¼šæŠŠå«æœ‰åŒèŠ±æ‹¬å·çš„å­—ç¬¦ä¸²è§£ææˆæ ‡å‡†çš„ JavaScript è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">parse(<span class="string">`Hi &#123;&#123; user.name &#125;&#125;, &#123;&#123; colon &#125;&#125; is awesome.`</span>);</span><br><span class="line"><span class="comment">// =&gt; 'Hi ' + user.name + ', ' + colon + ' is awesome.'</span></span><br></pre></td></tr></table></figure>
<h4 id="extract-dependency"><a href="#extract-dependency" class="headerlink" title="extract dependency"></a>extract dependency</h4><p>æˆ‘ä»¬ä¼šé€šè¿‡ä¸‹é¢è¿™ä¸ªå‡½æ•°æ¥æå–å‡ºä¸€ä¸ªè¡¨è¾¾å¼ä¸­å¯èƒ½å­˜åœ¨çš„å˜é‡ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dependencyRE = <span class="regexp">/"[^"]*"|'[^']*'|\.\w*[a-zA-Z$_]\w*|\w*[a-zA-Z$_]\w*:|(\w*[a-zA-Z$_]\w*)/g</span>;</span><br><span class="line"><span class="keyword">const</span> globals = [</span><br><span class="line">    <span class="string">'true'</span>, <span class="string">'false'</span>, <span class="string">'undefined'</span>, <span class="string">'null'</span>, <span class="string">'NaN'</span>, <span class="string">'isNaN'</span>, <span class="string">'typeof'</span>, <span class="string">'in'</span>,</span><br><span class="line">    <span class="string">'decodeURI'</span>, <span class="string">'decodeURIComponent'</span>, <span class="string">'encodeURI'</span>, <span class="string">'encodeURIComponent'</span>, <span class="string">'unescape'</span>,</span><br><span class="line">    <span class="string">'escape'</span>, <span class="string">'eval'</span>, <span class="string">'isFinite'</span>, <span class="string">'Number'</span>, <span class="string">'String'</span>, <span class="string">'parseFloat'</span>, <span class="string">'parseInt'</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractDependencies</span>(<span class="params">expression</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> dependencies = [];</span><br><span class="line"></span><br><span class="line">    expression.replace(dependencyRE, (match, dependency) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            dependency !== <span class="literal">undefined</span> &amp;&amp;</span><br><span class="line">            dependencies.indexOf(dependency) === <span class="number">-1</span> &amp;&amp;</span><br><span class="line">            globals.indexOf(dependency) === <span class="number">-1</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            dependencies.push(dependency);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dependencies;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ <code>dependencyRE</code> åŒ¹é…å‡ºå¯èƒ½çš„å˜é‡ä¾èµ–åï¼Œè¿˜è¦è¿›è¡Œä¸€äº›å¯¹æ¯”ï¼Œæ¯”å¦‚æ˜¯å¦æ˜¯å…¨å±€å˜é‡ç­‰ç­‰ã€‚æ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">extractDependencies(<span class="string">`typeof String(name) === 'string'  &amp;&amp; 'Hello ' + world + '! ' + hello.split('').join('') + '.'`</span>);</span><br><span class="line"><span class="comment">// =&gt; ["name", "world", "hello"]</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„ç»“æœï¼Œ<code>typeof</code>, <code>String</code>, <code>split</code> å’Œ <code>join</code> å¹¶ä¸æ˜¯ <code>data</code> ä¸­æ‰€ä¾èµ–çš„å˜é‡ï¼Œæ‰€ä»¥ä¸éœ€è¦è¢«æå–å‡ºæ¥ã€‚</p>
<h4 id="generate-1"><a href="#generate-1" class="headerlink" title="generate"></a>generate</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">generate</span>(<span class="params">expression</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> dependencies = extractDependencies(expression);</span><br><span class="line">    <span class="keyword">let</span> dependenciesCode = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    dependencies.map(<span class="function"><span class="params">dependency</span> =&gt;</span> dependenciesCode += <span class="string">`var <span class="subst">$&#123;dependency&#125;</span> = this.get("<span class="subst">$&#123;dependency&#125;</span>"); `</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">`data`</span>, <span class="string">`<span class="subst">$&#123;dependenciesCode&#125;</span>return <span class="subst">$&#123;expression&#125;</span>;`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æå–å˜é‡çš„ç›®çš„å°±æ˜¯ä¸ºäº†åœ¨ <code>generate</code> å‡½æ•°ä¸­ç”Ÿæˆç›¸åº”çš„å˜é‡èµ‹å€¼çš„å­—ç¬¦ä¸²ä¾¿äºåœ¨ <code>generate</code> å‡½æ•°ä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">`data`</span>, <span class="string">`</span></span><br><span class="line"><span class="string">    var name = data["name"];</span></span><br><span class="line"><span class="string">    var world = data["world"];</span></span><br><span class="line"><span class="string">    var hello = data["hello"];</span></span><br><span class="line"><span class="string">    return typeof String(name) === 'string'  &amp;&amp; 'Hello ' + world + '! ' + hello.split('').join('') + '.';</span></span><br><span class="line"><span class="string">`</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// will generated:</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name = data[<span class="string">"name"</span>];</span><br><span class="line">    <span class="keyword">var</span> world = data[<span class="string">"world"</span>];</span><br><span class="line">    <span class="keyword">var</span> hello = data[<span class="string">"hello"</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> <span class="built_in">String</span>(name) === <span class="string">'string'</span>  &amp;&amp; <span class="string">'Hello '</span> + world + <span class="string">'! '</span> + hello.split(<span class="string">''</span>).join(<span class="string">''</span>) + <span class="string">'.'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·çš„è¯ï¼Œåªéœ€è¦åœ¨è°ƒç”¨è¿™ä¸ªåŒ¿åå‡½æ•°çš„æ—¶å€™ä¼ å…¥å¯¹åº”çš„ <code>data</code> å³å¯è·å¾—æˆ‘ä»¬æƒ³è¦çš„ç»“æœäº†ã€‚ç°åœ¨å›è¿‡å¤´æ¥çœ‹ä¹‹å‰çš„ <code>Directive</code> éƒ¨åˆ†ä»£ç åº”è¯¥å°±ä¸€ç›®äº†ç„¶äº†ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Directive</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">this</span>.beforeUpdate &amp;&amp; <span class="keyword">this</span>.beforeUpdate();</span><br><span class="line">        <span class="keyword">this</span>.update &amp;&amp; <span class="keyword">this</span>.update(generate(<span class="keyword">this</span>.expression)(<span class="keyword">this</span>.compile.data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>generate(this.expression)(this.compile.data)</code> å°±æ˜¯è¡¨è¾¾å¼ç»è¿‡ <code>this.compile.data</code> è®¡ç®—åæˆ‘ä»¬æ‰€éœ€è¦çš„å€¼ã€‚</p>
<h3 id="compile-text-node"><a href="#compile-text-node" class="headerlink" title="compile text node"></a>compile text node</h3><p>æˆ‘ä»¬å‰é¢åªè®²äº†å¦‚ä½•ç¼–è¯‘ <code>node.nodeType === 1</code> çš„å…ƒç´ èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ–‡å­—èŠ‚ç‚¹å¦‚ä½•ç¼–è¯‘å‘¢ï¼Œå…¶å®ç†è§£äº†å‰é¢æ‰€è®²çš„å†…å®¹è¯ï¼Œæ–‡å­—èŠ‚ç‚¹çš„ç¼–è¯‘å°±ç®€å•å¾—ä¸èƒ½å†ç®€å•äº†ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * compile text node</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;Node&#125; node</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Compile.compile.textNodes = <span class="function"><span class="keyword">function</span> (<span class="params">node</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node.textContent.trim() === <span class="string">''</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.bindDirective(&#123;</span><br><span class="line">        node,</span><br><span class="line">        name: <span class="string">'text'</span>,</span><br><span class="line">        expression: parse.text(node.textContent),</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ç»‘å®š <code>text</code> æŒ‡ä»¤ï¼Œå¹¶ä¼ å…¥è§£æåçš„ JavaScript è¡¨è¾¾å¼ï¼Œåœ¨ <code>Directive</code> å†…éƒ¨å°±ä¼šè®¡ç®—å‡ºè¡¨è¾¾å¼å®é™…çš„å€¼å¹¶è°ƒç”¨ <code>text</code> çš„ <code>update</code> å‡½æ•°æ›´æ–°è§†å›¾å®Œæˆæ¸²æŸ“ã€‚</p>
<h2 id="each-æŒ‡ä»¤"><a href="#each-æŒ‡ä»¤" class="headerlink" title=":each æŒ‡ä»¤"></a><code>:each</code> æŒ‡ä»¤</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¯¥æ¨¡æ¿å¼•æ“åªå®ç°äº†æ¯”è¾ƒåŸºæœ¬çš„åŠŸèƒ½ï¼Œè€Œæœ€å¸¸è§ä¸”é‡è¦çš„åˆ—è¡¨æ¸²æŸ“åŠŸèƒ½è¿˜æ²¡æœ‰å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¦å®ç°ä¸€ä¸ª <code>:each</code> æŒ‡ä»¤æ¥æ¸²æŸ“ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™é‡Œå¯èƒ½è¦æ³¨æ„ä¸€ä¸‹ï¼Œä¸èƒ½æŒ‰ç…§å‰é¢ä¸¤ä¸ªæŒ‡ä»¤çš„æ€è·¯æ¥å®ç°ï¼Œåº”è¯¥æ¢ä¸€ä¸ªè§’åº¦æ¥æ€è€ƒï¼Œåˆ—è¡¨æ¸²æŸ“å…¶å®ç›¸å½“äºä¸€ä¸ªã€Œå­æ¨¡æ¿ã€ï¼Œé‡Œé¢çš„å˜é‡å­˜åœ¨äº <code>:each</code> æŒ‡ä»¤æ‰€æ¥æ”¶çš„ <code>data</code> è¿™ä¸ªã€Œå±€éƒ¨ä½œç”¨åŸŸã€ä¸­ï¼Œè¿™ä¹ˆè¯´å¯èƒ½æŠ½è±¡ï¼Œç›´æ¥ä¸Šä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// :each updater</span></span><br><span class="line"><span class="keyword">import</span> Compile <span class="keyword">from</span> <span class="string">'path/to/compile.js'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    beforeUpdate() &#123;</span><br><span class="line">        <span class="keyword">this</span>.placeholder = <span class="built_in">document</span>.createComment(<span class="string">`:each`</span>);</span><br><span class="line">        <span class="keyword">this</span>.node.parentNode.replaceChild(<span class="keyword">this</span>.placeholder, <span class="keyword">this</span>.node);</span><br><span class="line">    &#125;,</span><br><span class="line">    update() &#123;</span><br><span class="line">        <span class="keyword">if</span> (data &amp;&amp; !<span class="built_in">Array</span>.isArray(data)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line"></span><br><span class="line">        data.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> compiled = Compile(<span class="keyword">this</span>.node.cloneNode(<span class="literal">true</span>), &#123; item, index, &#125;);</span><br><span class="line">            fragment.appendChild(compiled.view);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.placeholder.parentNode.replaceChild(fragment, <span class="keyword">this</span>.placeholder);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>update</code> ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŠŠ <code>:each</code> æ‰€åœ¨èŠ‚ç‚¹ä» DOM ç»“æ„ä¸­å»æ‰ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯å¹¶ä¸èƒ½ç›´æ¥å»æ‰ï¼Œè€Œæ˜¯è¦åœ¨å»æ‰çš„ä½ç½®æ’å…¥ä¸€ä¸ª <code>comment</code> ç±»å‹çš„èŠ‚ç‚¹ä½œä¸ºå ä½ç¬¦ï¼Œç›®çš„æ˜¯ä¸ºäº†åœ¨æˆ‘ä»¬æŠŠåˆ—è¡¨æ•°æ®æ¸²æŸ“å‡ºæ¥åï¼Œèƒ½æ‰¾å›åŸæ¥çš„ä½ç½®å¹¶æŠŠå®ƒæ’å…¥åˆ° DOM ä¸­ã€‚</p>
<p>é‚£å…·ä½“å¦‚ä½•ç¼–è¯‘è¿™ä¸ªæ‰€è°“çš„ã€Œå­æ¨¡æ¿ã€å‘¢ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦éå† <code>:each</code> æŒ‡ä»¤æ‰€æ¥æ”¶çš„ <code>Array</code> ç±»å‹çš„æ•°æ®ï¼ˆç›®å‰åªæ”¯æŒè¯¥ç±»å‹ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å¢åŠ å¯¹ <code>Object</code> ç±»å‹çš„æ”¯æŒï¼ŒåŸç†æ˜¯ä¸€æ ·çš„ï¼‰ï¼›å…¶æ¬¡ï¼Œæˆ‘ä»¬é’ˆå¯¹è¯¥åˆ—è¡¨çš„æ¯ä¸€é¡¹æ•°æ®è¿›è¡Œä¸€æ¬¡æ¨¡æ¿çš„ç¼–è¯‘å¹¶æŠŠæ¸²æŸ“åçš„æ¨¡æ¿æ’å…¥åˆ°åˆ›å»ºçš„ <code>document fragment</code> ä¸­ï¼Œå½“æ‰€æœ‰æ•´ä¸ªåˆ—è¡¨ç¼–è¯‘å®Œåå†æŠŠåˆšåˆšåˆ›å»ºçš„ <code>comment</code> ç±»å‹çš„å ä½ç¬¦æ›¿æ¢ä¸º <code>document fragment</code> ä»¥å®Œæˆåˆ—è¡¨çš„æ¸²æŸ“ã€‚</p>
<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆä½¿ç”¨ <code>:each</code> æŒ‡ä»¤ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Compile(<span class="string">`&lt;li :each="comments" data-index="&#123;&#123; index &#125;&#125;"&gt;&#123;&#123; item.content &#125;&#125;&lt;/li&gt;`</span>, &#123;</span><br><span class="line">    comments: [&#123;</span><br><span class="line">        content: <span class="string">`Hello World.`</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        content: <span class="string">`Just Awesome.`</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        content: <span class="string">`WOW, Just WOW!`</span>,</span><br><span class="line">    &#125;],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>ä¼šæ¸²æŸ“æˆï¼š</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-index</span>=<span class="string">"0"</span>&gt;</span>Hello World.<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-index</span>=<span class="string">"1"</span>&gt;</span>Just Awesome.<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-index</span>=<span class="string">"2"</span>&gt;</span>WOW, Just WOW!<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å…¶å®ç»†å¿ƒçš„è¯ä½ ä¼šå‘ç°ï¼Œæ¨¡æ¿ä¸­ä½¿ç”¨çš„ <code>item</code> å’Œ <code>index</code> å˜é‡å…¶å®å°±æ˜¯ <code>:each</code> æ›´æ–°å‡½æ•°ä¸­ <code>Compile(template, data)</code> ç¼–è¯‘å™¨é‡Œçš„ <code>data</code> å€¼çš„ä¸¤ä¸ª <code>key</code> å€¼ã€‚æ‰€ä»¥è¦è‡ªå®šä¹‰è¿™ä¸¤ä¸ªå˜é‡ä¹Ÿæ˜¯éå¸¸ç®€å•çš„ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// :each updater</span></span><br><span class="line"><span class="keyword">import</span> Compile <span class="keyword">from</span> <span class="string">'path/to/compile.js'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    beforeUpdate() &#123;</span><br><span class="line">        <span class="keyword">this</span>.placeholder = <span class="built_in">document</span>.createComment(<span class="string">`:each`</span>);</span><br><span class="line">        <span class="keyword">this</span>.node.parentNode.replaceChild(<span class="keyword">this</span>.placeholder, <span class="keyword">this</span>.node);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// parse alias</span></span><br><span class="line">        <span class="keyword">this</span>.itemName = <span class="string">`item`</span>;</span><br><span class="line">        <span class="keyword">this</span>.indexName = <span class="string">`index`</span>;</span><br><span class="line">        <span class="keyword">this</span>.dataName = <span class="keyword">this</span>.expression;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.expression.indexOf(<span class="string">' in '</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> bracketRE = <span class="regexp">/\(((?:.|\n)+?)\)/g</span>;</span><br><span class="line">            <span class="keyword">const</span> [item, data] = <span class="keyword">this</span>.expression.split(<span class="string">' in '</span>);</span><br><span class="line">            <span class="keyword">let</span> matched = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (matched = bracketRE.exec(item)) &#123;</span><br><span class="line">                <span class="keyword">const</span> [item, index] = matched[<span class="number">1</span>].split(<span class="string">','</span>);</span><br><span class="line">                index ? <span class="keyword">this</span>.indexName = index.trim() : <span class="string">''</span>;</span><br><span class="line">                <span class="keyword">this</span>.itemName = item.trim();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.itemName = item.trim();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.dataName = data.trim();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.expression = <span class="keyword">this</span>.dataName;</span><br><span class="line">    &#125;,</span><br><span class="line">    update() &#123;</span><br><span class="line">        <span class="keyword">if</span> (data &amp;&amp; !<span class="built_in">Array</span>.isArray(data)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line"></span><br><span class="line">        data.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> compiled = Compile(<span class="keyword">this</span>.node.cloneNode(<span class="literal">true</span>), &#123;</span><br><span class="line">                [<span class="keyword">this</span>.itemName]: item,</span><br><span class="line">                [<span class="keyword">this</span>.indexName]: index,</span><br><span class="line">            &#125;);</span><br><span class="line">            fragment.appendChild(compiled.view);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.placeholder.parentNode.replaceChild(fragment, <span class="keyword">this</span>.placeholder);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>(aliasItem, aliasIndex) in items</code> æ¥è‡ªå®šä¹‰ <code>:each</code> æŒ‡ä»¤çš„ <code>item</code> å’Œ <code>index</code> å˜é‡äº†ï¼ŒåŸç†å°±æ˜¯åœ¨ <code>beforeUpdate</code> çš„æ—¶å€™å»è§£æ <code>:each</code> æŒ‡ä»¤çš„è¡¨è¾¾å¼ï¼Œæå–ç›¸å…³çš„å˜é‡åï¼Œç„¶åä¸Šé¢çš„ä¾‹å­å°±å¯ä»¥å†™æˆè¿™æ ·äº†ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Compile(<span class="string">`&lt;li :each="(comment, index) in comments" data-index="&#123;&#123; index &#125;&#125;"&gt;&#123;&#123; comment.content &#125;&#125;&lt;/li&gt;`</span>, &#123;</span><br><span class="line">    comments: [&#123;</span><br><span class="line">        content: <span class="string">`Hello World.`</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        content: <span class="string">`Just Awesome.`</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        content: <span class="string">`WOW, Just WOW!`</span>,</span><br><span class="line">    &#125;],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åˆ°è¿™é‡Œï¼Œå…¶å®ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ¨¡æ¿å¼•æ“ç®—æ˜¯å®ç°äº†ï¼Œå½“ç„¶è¿˜æœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥å®Œå–„çš„ï¼Œæ¯”å¦‚å¯ä»¥å¢åŠ  <code>:class</code>, <code>:style</code>, <code>:if</code> æˆ– <code>:src</code> ç­‰ç­‰ä½ å¯ä»¥æƒ³åˆ°çš„æŒ‡ä»¤åŠŸèƒ½ï¼Œæ·»åŠ è¿™äº›åŠŸèƒ½éƒ½æ˜¯éå¸¸çš„ç®€å•çš„ã€‚</p>
<p>å…¨ç¯‡ä»‹ç»ä¸‹æ¥ï¼Œæ•´ä¸ªæ ¸å¿ƒæ— éå°±æ˜¯éå†æ•´ä¸ªæ¨¡æ¿çš„èŠ‚ç‚¹æ ‘ï¼Œå…¶æ¬¡é’ˆå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å­—ç¬¦ä¸²å€¼æ¥è§£ææˆå¯¹åº”çš„è¡¨è¾¾å¼ï¼Œç„¶åé€šè¿‡ <code>new Function()</code> è¿™ä¸ªæ„é€ å‡½æ•°æ¥è®¡ç®—æˆå®é™…çš„å€¼ï¼Œæœ€ç»ˆé€šè¿‡æŒ‡ä»¤çš„ <code>update</code> å‡½æ•°æ¥æ›´æ–°åˆ°è§†å›¾ä¸Šã€‚</p>
<p>å¦‚æœè¿˜æ˜¯ä¸æ¸…æ¥šè¿™äº›æŒ‡ä»¤å¦‚ä½•ç¼–å†™çš„è¯ï¼Œå¯ä»¥å‚è€ƒæˆ‘è¿™ä¸ªé¡¹ç›® <a href="https://github.com/colonjs/colon" target="_blank" rel="noopener">colon</a> çš„ç›¸å…³æºç ï¼ˆéƒ¨åˆ†ä»£ç å¯èƒ½ä¼šæœ‰ä¸å½±å“ç†è§£çš„ç»†å¾®å·®åˆ«ï¼Œå¯å¿½ç•¥ï¼‰ï¼Œæœ‰ä»»ä½•é—®é¢˜éƒ½å¯ä»¥åœ¨ issue ä¸Šæã€‚</p>
<p>ç›®å‰æœ‰ä¸€ä¸ªå±€é™å°±æ˜¯ DOM-based çš„æ¨¡æ¿å¼•æ“åªé€‚ç”¨äºæµè§ˆå™¨ç«¯ï¼Œç›®å‰ç¬”è€…ä¹Ÿæ­£åœ¨å®ç°å…¼å®¹ Node ç«¯çš„ç‰ˆæœ¬ï¼Œæ€è·¯æ˜¯æŠŠå­—ç¬¦ä¸²æ¨¡æ¿è§£ææˆ ASTï¼Œç„¶åæŠŠæ›´æ–°æ•°æ®åˆ° AST ä¸Šï¼Œæœ€åå†æŠŠ AST è½¬æˆå­—ç¬¦ä¸²æ¨¡æ¿ï¼Œå®ç°å‡ºæ¥åæœ‰ç©ºçš„è¯å†æ¥ä»‹ç»ä¸€ä¸‹ Node ç«¯çš„å®ç°ã€‚</p>

            </section>
            <footer class="article-meta">
                <!--  -->
            </footer>
        </article>
    </div>
</div>

<footer class="footer text-center">
    <div class="container">
        <section class="copyright">
            <a href="http://fe.meitu.com/">MEITU FE</a>
            <span>&copy; 2017</span>
        </section>
    </div>
</footer>

    <script src="/dist/js/highlight.pack.js"></script>
    <script src="/dist/js/app.js"></script>
</body>
</html>

